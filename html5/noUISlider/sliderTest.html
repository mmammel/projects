<html>
  <head>
    <link href="nouislider.css" rel="stylesheet">
  </head>
  <body>

    <div id="sliderContainer"></div>
    <p></p>
    <div id="sliderContainer2"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="nouislider.js"></script>
    <script type="text/javascript">
      // Red -> Green
      var gradient = [ '#ff0000', '#ff6600', '#ff9900', '#ffcc00', '#ffcc66', '#ffff00', '#ffff66', '#ccff33', '#66ff66', '#00ff00' ]
      var gradientMasks = [0b0000000001,0b1000000001,0b1000010001,0b1010010001,0b1010010101,0b1101010101,0b1101011101,0b1101111101,0b1111111101,0b1111111111];

      function getGradient( numBands ) {
        var retVal = [];
        var mask = ( numBands >= 1 && numBands <= 10 ) ? gradientMasks[ numBands - 1 ] : gradientMasks[ 0 ];
        for ( var i = 0; i < gradient.length; i++ ) {
          if( (mask >> (9 - i)) & 1 === 1 ) {
            retVal.push( gradient[i] );
          }
        }

        if( retVal.length === 1 ) retVal.push( retVal[0] ); // "no cuts" is actually still one cut, just hidden, so two segments.

        return retVal;
      }

      function Cutoffs( hostId ) {
        this.hostId = hostId;
        this.hostEle = $('#' + hostId );
        this.hostEle.append( '<div id="'+hostId+'_inner"></div>' );
        this.slider = $('#' + hostId + '_inner' )[0];
        this.min = 0;
        this.max = 100;
        this.cuts = [];

        this.hardUpdate();

        this.hostEle.on('dblclick', (e) => {
          var n = (e.clientX / $(e.currentTarget).width() ) * ( this.max - this.min );
          this.addCut( n );
        });
      };

      Cutoffs.prototype.softUpdate = function() {
        this.slider.noUiSlider.updateOptions({
          range: {
            'min' : this.min,
            'max' : this.max
          }
        });
      };

      Cutoffs.prototype.hardUpdate = function() {
        if( this.slider.noUiSlider ) {
          this.slider.noUiSlider.destroy();
        }

        var connects = [];
        if( this.cuts.length === 0 ) {
          connects = [true, true ];
        } else {
          for( var i = 0; i < this.cuts.length + 1; i++ ) {
            connects.push( true );
          }
        }

        noUiSlider.create( this.slider, {
          start: this.cuts.length === 0 ? [0] : this.cuts,
          connect: connects,
          orientation: 'horizontal',
          behaviour: 'drag',
          range: {
            'min' : this.min,
            'max' : this.max
          }
        });

        if( this.cuts.length === 0 ) {
          $('#' + this.hostId + ' .noUi-handle').hide();
        } else {
          $('#' + this.hostId + ' .noUi-handle').show();
        }

        var colors = getGradient( this.getNumBands() );

        var connectors = $('#' + this.hostId + ' .noUi-connect');

        for( var i = 0; i < connectors.length; i++ ) {
          $(connectors[i]).css('background', colors[i] );
        }
      };

      Cutoffs.prototype.getNumBands = function() {
        return this.cuts.length + 1;
      };

      Cutoffs.prototype.setMin = function( n ) {
        this.min = n < this.max ? n : this.min;
        this.softUpdate();
      };

      Cutoffs.prototype.setMax = function( n ) {
        this.max = n > this.min ? n : this.max;
        this.softUpdate();
      };

      Cutoffs.prototype.addCut = function( n ) {
        var newCuts = [];
        var inserted = false;

        if( n > this.min && n < this.max ) {
          if( this.cuts.length === 0 ) {
            newCuts.push( n );
          } else {
            for( var i = 0; i < this.cuts.length; i++ ) {
              if( this.cuts[i] > n && !inserted ) {
                newCuts.push(n);
                inserted = true;
              }
              newCuts.push( this.cuts[i] );
            }
            if( !inserted ) newCuts.push(n);
          }

          this.cuts = newCuts;
          this.hardUpdate();
        }
      }

      var theCutoffs, theCutoffs2;

      $(document).ready(function() {
        theCutoffs = new Cutoffs( 'sliderContainer' );
        theCutoffs2 = new Cutoffs( 'sliderContainer2' );
      });
    </script>
  </body>
</html>
