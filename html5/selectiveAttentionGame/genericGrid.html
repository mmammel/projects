<!doctype html>
<html lang="en">
 <head>  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=1.0, user-scalable=0">
  <style type="text/css">
    body {
      font-family: sans-serif;
    }

    .instructionShapeHolder {
      width: 100px;
    }

    .instructionText {
      font-size: 28px;
      font-weight: bold;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="grid.js"></script>
  <script type="application/javascript">  
    var theGrid;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1)); // random index from 0 to i
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function buildImageSVG(shape) {
      var retVal = makeSVG("svg", { id: 'svgInstruction_'+shape, viewBox: '0 0 20 20' });
      if( shape === '+' ) {
        var vertRect = makeSVG('rect', {
            id: 'instr_decorator_vert', x: '7', y: '2', width: '6', height: '16', 
            fill: 'black', 'stroke-width': 0
            });
        var horizRect = makeSVG('rect', {
            id: 'instr_decorator_horiz', x: '2', y: '7', width: '16', height: '6', 
            fill: 'black', 'stroke-width': 0
            });
            $(retVal).append(vertRect);
            $(retVal).append(horizRect);
      } else if( shape === 'o' ) {
        var outerCircle = makeSVG('circle', {
            id: 'instr_o_decorator_outer', cx: 10, cy: 10,
              r: 8, fill: 'black', 'stroke-width': 0
            });
            $(retVal).append(outerCircle);
      } else if( shape === 't' ) {
        var triangle = makeSVG('polygon', {
            id: 'instr_t_decorator_inner', 
               points: ''+ 10 + ',' + 3 + ' ' + 
                           (10 + (14 / Math.sqrt(3))) + ',' + (10+ (14 / Math.sqrt(3))) + ' ' +
                           (10 - (14 / Math.sqrt(3))) + ',' + (10 + (14 / Math.sqrt(3))), 
               fill: 'black', 'stroke-width': 0
            });
            $(retVal).append(triangle);
      } else if( shape === 'p' ) {
        var cx = 10;
        var cy = 10;
        var rad18 = 18 * (Math.PI / 180);
        var rad54 = 54 * (Math.PI / 180);
        var pentagon = makeSVG('polygon', {
        id: 'instr_p_decorator_inner', 
            points: ''+ cx + ',' + (cy - 8) + ' ' + 
                        (cx + (8 * Math.cos(rad18))) + ',' + (cy - (8 * Math.sin(rad18))) + ' ' +
                        (cx + (8 * Math.cos(rad54))) + ',' + (cy + (8 * Math.sin(rad54))) + ' ' +
                        (cx - (8 * Math.cos(rad54))) + ',' + (cy + (8 * Math.sin(rad54))) + ' ' +
                        (cx - (8 * Math.cos(rad18))) + ',' + (cy - (8 * Math.sin(rad18))),
            fill: 'black', 'stroke-width': 0
        });
        $(retVal).append(pentagon);
      }

      return retVal;
    }

    function buildInstructionTable() {

      var tempShapeHolder = null;
      var tempRow = null;
      var retVal = $('<table id="instructionTable" style="margin:auto;">');
      for( var i = 0; i < theGrid.shapes.length; i++ ) {
        tempRow = $('<tr></tr>');
        tempShapeHolder = $('<td class="instructionShapeHolder" id="shapeHolder_' + i + '"></td>');
        tempRow.append(tempShapeHolder);
        tempShapeHolder.append(buildImageSVG(theGrid.shapes[i]));
        tempRow.append($('<td class="instructionText"> = '+theGrid.points[i] +' Point' + (i == 0 ? '' : 's') + '</td>'));
        retVal.append(tempRow);
      }
      return retVal;
    }

    function getURLParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    function fitGrid() {
      var availableHeight = window.innerHeight - $('#svg').offset().top - 40;
      // c/r * h => max-width
      var maxWidth = (theGrid.cols / theGrid.rows) * availableHeight;
      $('#svg').css('max-width', ''+maxWidth+'px');
    }

    $(document).ready( function() {
      var gridRows = getURLParameter('r');
      var gridCols = getURLParameter('c');
      var gridStartRow = getURLParameter('sr');
      var gridStartCol = getURLParameter('sc');
      var gridEndRow = getURLParameter('er');
      var gridEndCol = getURLParameter('ec');
      var instructionTime = getURLParameter('t');

      gridRows = gridRows == null ? 8 : parseInt(gridRows);
      gridCols = gridCols == null ? 6 : parseInt(gridCols);
      gridStartRow = gridStartRow == null ? gridRows - 1 : parseInt(gridStartRow);
      gridStartCol = gridStartCol == null ? gridCols - 1 : parseInt(gridStartCol);
      gridEndRow = gridEndRow == null ? 0 : parseInt(gridEndRow);
      gridEndCol = gridEndCol == null ? 0 : parseInt(gridEndCol);
      instructionTime = instructionTime == null ? 30 : parseInt(instructionTime);

      // if( gridRows > 50 ) {
      //   gridRows = 50;
      //   gridStartRow = 49;
      //   gridEndRow = 0;
      // }

      // if( gridCols > 50 ) {
      //   gridCols = 50;
      //   gridStartCol = 49;
      //   gridEndCol = 0;
      // }

      theGrid = new Grid( 'svg', gridRows, gridCols, [gridStartRow, gridStartCol ], [gridEndRow, gridEndCol] );
      $('#instructions').append(buildInstructionTable());
      var counter = instructionTime;
      $('#timeLimit').text(''+counter--);
      var instructionInterval = setInterval(function(){
        $('#timeLimit').text(''+counter--);
      },1000);

      setTimeout(function() {
        clearInterval(instructionInterval);
        $('#instructions').hide();
        $('#gameBoard').show()
        fitGrid();
      }, 1000*instructionTime);
      theGrid.draw();
      window.onresize = fitGrid;
      theGrid.computeOptimalPath();
    });
    
  </script>  
 </head>  
 <body>
   <div id="instructions">
     <h1>Please take the next <span id="timeLimit">30</span> seconds to memorize the following relationships:</h1>
   </div>
   <div style="display:none;" id="gameBoard">
    <h1>Find a path from "A" to "B", accumulating the fewest points possible.  Good luck!</h1>
    <!--<h3 id="pathPoints">0</h3>-->
    <div id="svg" style="max-width: 600px; padding: 20px; margin:auto;">
    </div>
   </div>
  </body>  
</html>  

