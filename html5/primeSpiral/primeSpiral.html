<html>  
 <head>  
  <style type="text/css">
    label {
      font-family: "Helvetica";
      padding-right: 5px;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="bigConstants.js"></script>
  <script type="text/javascript" src="checkers.js"></script>
  <script type="application/javascript">  

  var viewBox = [ -320, -320, 640, 640 ];
  var coords = [ 0, 0 ];
  var color = '#FF0000';
  var currTheta = 0;
  var deltaTheta = 90;
  var modifiers = [ [2,0], [0,2], [-2,0], [0,-2] ];
  var modifierIdx = 0;
  var primeIdx = 0;
  var primeDotMap = {};
  //var num = 0;
  var drawInterval = null;
  var iterations = 80000;

  function expand() {
    viewBox[0] -= (.25 * viewBox[2] );
    viewBox[1] -= (.25 * viewBox[3] );
    viewBox[2] *= 1.5;
    viewBox[3] *= 1.5;
    resize();
  }

  function contract() {
    viewBox[2] *= .6666;
    viewBox[3] *= .6666;
    viewBox[0] += (.25 * viewBox[2] );
    viewBox[1] += (.25 * viewBox[3] );
    resize();
  }

  function centerOnOffset( offx, offy ) {
    var w = $('#svgRoot').width();
    var h = $('#svgRoot').height();
    viewBox[0] += (((offx - (w/2)) / w) * viewBox[2]);
    viewBox[1] += (((offy - (h/2)) / h) * viewBox[3]);
    contract();
  }

  function resize() {
    document.getElementById("svgRoot").setAttribute("viewBox", ''+viewBox[0] + ' ' + viewBox[1] + ' ' + viewBox[2] + ' ' + viewBox[3] );
    var w = 1000 / viewBox[2];
    var h = 1000 / viewBox[3];
    document.getElementById( "grid" ).setAttribute("width", ''+w+'%');
    document.getElementById( "grid" ).setAttribute("height", ''+h+'%');
    document.getElementById( "gridRect" ).setAttribute("x", ''+viewBox[0]);
    document.getElementById( "gridRect" ).setAttribute("y", ''+viewBox[1]);
    document.getElementById( "gridRect" ).setAttribute("width", ''+viewBox[2]);
    document.getElementById( "gridRect" ).setAttribute("height", ''+viewBox[3]);
  }

  function resetDisplay() {
    $('#spiralPoints').empty();
    coords = [ 0, 0 ];
    modifiers = [ [2,0], [0,2], [-2,0], [0,-2] ];
    modifierIdx = 0;
    currTheta = 0;
    primeIdx = 0;
    primeDotMap = {};
    viewBox[0] = -320;
    viewBox[1] = -320;
    viewBox[2] = 640;
    viewBox[3] = 640;
    resize();
  }

  function multipleOf( n, m ) {
    return n % m == 0;
  }
  
  function makeSVG(tag, attrs) {
    var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (var k in attrs)
      el.setAttribute(k, attrs[k]);
    return el;
  }

  function validateInputs() {
    let retVal = true;
    let errorMessage = '';
    if( currChecker == null ) {
      retVal = false;
      errorMessage += "Select a checker!";
    } else {
      if( ! /[0-9]+/.test($('#numIterations').val()) ) {
        retVal = false;
        errorMessage += '# of Iterations must be numeric (more the merrier)\n';
      }


      if( ! /[0-9]+/.test($('#deltaTheta').val()) ) {
        retVal = false;
        errorMessage += 'Angle must be a number between 0 and 360 inclusive';
      } else {
        var dtheta = parseFloat( $('#deltaTheta').val() );
        if( dtheta < 0.0 || dtheta > 360.0 ) {
          retVal = false;
          errorMessage += 'Angle must be between 0 and 360 inclusive';
        }
      }

      if( currChecker.extraVars != null && currChecker.extraVars.length > 0 ) {
        for( let i = 0; i < currChecker.extraVars.length; i++ ) {
          if( $('#'+currChecker.extraVars[i].id).val() == null ) {
            errorMessage += 'Need input for "' + currChecker.extraVars[i].label + '" field\n';
            retVal = false;
          }
        }
      }
    }

    if( !retVal && errorMessage.length > 0 ) {
      alert(errorMessage);
    }

    return retVal;
  }

  function draw() {
    resetDisplay();
    color = $('#pointColor').val();
    iterations = parseInt( $('#numIterations').val() );
    deltaTheta = parseFloat( $('#deltaTheta').val() );
    deltaTheta = deltaTheta * ( Math.PI / 180.0 );
    let extraVars = [];
    let extraVarValues = [0,0,0,0,0];
    let stateObj = JSON.parse(JSON.stringify(currChecker.stateObj));
    extraVars = currChecker.extraVars;
    if( extraVars != null && extraVars.length > 0 ) {
      for( let ex = 0; ex < extraVars.length; ex++ ) {
        extraVarValues[ex] = parseFloat( $('#'+extraVars[ex].id).val() );
      }
    }

    for( var i = 1; i < iterations; i++ ) {
      drawInner( stateObj, i, extraVarValues[0], extraVarValues[1] );
    }
  }
    
  function drawInner(state, i,j,k) {
    var key = '';
    if( currChecker.checker(state, i,j,k) ) {

      if( coords[0] < viewBox[0] ||
          coords[0] > (viewBox[0] + viewBox[2]) ||
          coords[1] < viewBox[1] ||
          coords[1] > (viewBox[1] + viewBox[3]) ) {
        expand();
      }
          
      //document.getElementById( "currPrime" ).innerHTML = ''+i;
      key = ''+coords[0] + '_' + coords[1];
      if( primeDotMap[ key ] ) {
        // we have a dot here already, increase it's size.
        var sz = primeDotMap[ key ];
        sz++;
        primeDotMap[ key ] = sz;
        var ele = document.getElementById( key );
        ele.setAttribute( "r", ''+sz );
      } else {
        primeDotMap[ key ] = 2;
        var ele = makeSVG("circle", { cx: ''+coords[0], cy: ''+coords[1], r: '2', id: key, fill: color } );
        var sp = document.getElementById("spiralPoints");
        sp.appendChild( ele ); 
      }

      // uncomment to go back to simple modifier
      //modifierIdx++;
      //if( modifierIdx == 4 ) modifierIdx = 0;
      currTheta += deltaTheta;
      if( currTheta > (2.0 * Math.PI) ) {
        currTheta -= (2.0 * Math.PI);
      }
    }

    // uncomment to go back to simple modifier
    //var mod = modifiers[modifierIdx];
    //coords[0] += mod[0];
    //coords[1] += mod[1];
    coords[0] += (2.0 * Math.cos( currTheta ));
    coords[1] += (2.0 * Math.sin( currTheta ));
  } 

  function initChecker() {
    if( currChecker != null ) {
      $('#checkerDescription').html( currChecker.description );
      $('#dynamicInputs').empty();
      let tempInput = "";
      let tempVar = {};
      if( currChecker.extraVars ) {
        for( let i = 0; i < currChecker.extraVars.length; i++ ) {
          tempInput = "<td>";
          tempVar = currChecker.extraVars[i];
          tempInput += "<label for='" + tempVar.id + "'>" + tempVar.label + "</label>";
          if( tempVar.values ) {
            // it's a select
            tempInput += "<select id='" + tempVar.id + "'><option value=''>Choose One</option>";
            for( let i = 0; i < tempVar.values.length; i++ ) {
              tempInput += "<option value='" + tempVar.values[i] + "'>" + tempVar.values[i] + "</option>";
            }
            tempInput += "</select>";
          } else {
            // it's an input
            tempInput += "<input id='" + tempVar.id + "'/>";
          }

          tempInput += "</td>";
          $('#dynamicInputs').append($(tempInput));
        }
      }
    }
  }
  const checkerMap = {};
  let currChecker = null;
  $(document).ready(function() {
    let selectOptions = [["Select One",""]];
    let temp = [];
    for( var i = 0; i < checkers.length; i++ ) {
      temp = [];
      temp.push( checkers[i].name);
      temp.push( checkers[i].id);
      selectOptions.push(temp);
      checkerMap[checkers[i].id] = checkers[i];
    }
    $('#selectHolder').append($("<select id='checkerSelect'></select>"));
    for( let i = 0; i < selectOptions.length; i++ ) {
      $('#checkerSelect').append($("<option value='" + selectOptions[i][1]+ "'>" + selectOptions[i][0] + "</option>"));
    }
    $('#checkerSelect').on('change', function(e) {
      currChecker = checkerMap[$('#checkerSelect').val()];
      initChecker();
    });
    $('#submitBtn').on('click', function(e) {
      if( validateInputs() ) {
        draw();
      }
    });

    $('#svgRoot').on('click', function(e) {
      centerOnOffset( e.offsetX, e.offsetY );
    });
  });
  </script>  
 </head>  
 <body>
   <table>
     <tr>
       <td id="selectHolder"></td>
       <td id="checkerDescription"></td>
     </tr>
   </table>
   <table>
     <tr id="dynamicInputs"></tr>
   </table>
   <table>
     <tr>
       <td><label for="deltaTheta">Angle to turn by:</label><input type="text" value="90" size="10" id="deltaTheta"/></td>
       <td><label for="pointColor">Color of points:</label><input type="color" value="#FF0000" id="pointColor"/></td>
     </tr>
     <tr>
       <td><label for="numIterations"># of Iterations:</label><input type="text" value="80000" id="numIterations"/></td>
       <td><input id="submitBtn" type="button" value="Start"/></td>
       <td><input id="zoomin" type="button" value="+" onclick="contract();"/></td>
       <td><input id="zoomout" type="button" value="-" onclick="expand();"/></td>
     </tr>
   </table>
   <div id="svg">
     <svg id="svgRoot" viewBox="-320 -320 640 640" xmlns="http://www.w3.org/2000/svg">
       <defs>
         <pattern id="grid" viewBox="0,0,10,10" width="1.5625%" height="1.5625%">
           <circle cx="0" cy="0" r="1" fill="lightgrey"/>
           <circle cx="10" cy="0" r="1" fill="lightgrey"/>
           <circle cx="0" cy="10" r="1" fill="lightgrey"/>
           <circle cx="10" cy="10" r="1" fill="lightgrey"/>
         </pattern>
       </defs>
       <rect id="gridRect" x="-320" y="-320" width="640" height="640" fill="url('#grid')"/>
       <circle cx="0" cy="0" r="18" fill="black"/>
       <g id="spiralPoints">
       </g>
     </svg>
   </div>
  </body>  
</html>  

