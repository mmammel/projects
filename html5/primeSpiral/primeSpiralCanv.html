<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style type="text/css">
    label {
      font-family: "Helvetica";
      padding-right: 5px;
    }

    .disp {
      padding-right: 25px;
    }

    .btnFlip {
      transform: rotate(180deg);
    }

    * {
      touch-action: manipulation;
    }

    html,
    body {
      overscroll-behavior-y: contain;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="bigConstants.js"></script>
  <script type="text/javascript" src="checkers.js"></script>
  <script type="text/javascript">

    var viewBox = [-320, -320, 640, 640];

    var scale = 1.0;
    var resizing = false;
    var centerPoint = [0.0,0.0];
    var pointRadius = 5.0;

    var stagingCanvas = null;
    var connectTheDots = false;
    var coords = [0, 0];
    var color = '#A132EC';
    var backgroundColor = '#000000';
    var currTheta = 0;
    var deltaTheta = 90;
    var animationStep = .015;
    var reverse = false;
    var primeIdx = 0;
    var primeDotMap = {};
    var animating = false;
    var animationInterval = null;
    var frameID = null;
    var animationStepMultiplier = 1.0;
    var turnIncrease = 0.0;

    //var num = 0;
    var drawInterval = null;
    var iterations = 80000;

    function expand() {
      scale *= 2;
      resize();
      if (!animating && validateInputs()) {
          draw();
      }
    }

    function contract() {
      scale *= 0.5;
      resize();
      if (!animating && validateInputs()) {
          draw();
      }
    }

    function centerOnOffset(offx, offy) {
      var cnv = document.getElementById("canvasRoot");
      var newX = ((offx * viewBox[2]) / cnv.width) + viewBox[0];
      var newY = ((offy * viewBox[3]) / cnv.height) + viewBox[1];
      centerPoint = [ newX, newY ];
      // resize();
      // if( !animating && validateInputs() ) {
      //   draw();
      // }
      contract();
    }

    function resize() {
      $('#canvasContainer').css({ height: ($(window).innerHeight() - $('#controlPanel').height()) });
      var cnv = document.getElementById("canvasRoot");
      if( cnv.width != $('#canvasContainer').width()) cnv.width = $('#canvasContainer').width();
      cnv.height = $('#canvasContainer').height();
      viewBox[0] = centerPoint[0] - (scale * cnv.width / 2.0);
      viewBox[1] = centerPoint[1] - (scale * cnv.height / 2.0);
      viewBox[2] = cnv.width * scale;
      viewBox[3] = cnv.height * scale;
    }

    function initCanvas() {
      var canvas = document.getElementById('canvasRoot');
      stagingCanvas = document.createElement('canvas');
      stagingCanvas.width = canvas.width;
      stagingCanvas.height = canvas.height;
    }

    function resetDisplay() {
      initCanvas();
      coords = [0, 0];
      currTheta = 0;
      primeIdx = 0;
    }

    function multipleOf(n, m) {
      return n % m == 0;
    }

    function validateInputs() {
      let retVal = true;
      let errorMessage = '';
      if (currChecker == null) {
        retVal = false;
        errorMessage += "Select a checker!";
      } else {
        if (! /^[0-9]+$/.test($('#numIterations').val())) {
          retVal = false;
          errorMessage += '# of Iterations must be numeric (more the merrier)\n';
        }


        if (! /^[0-9]+(?:\.[0-9]+)?|\.[0-9]+$/.test($('#deltaTheta').val())) {
          retVal = false;
          errorMessage += 'Angle must be a number between 0 and 360 inclusive';
        } else {
          var dtheta = parseFloat($('#deltaTheta').val());
          if (dtheta < 0.0 || dtheta > 360.0) {
            retVal = false;
            errorMessage += 'Angle must be between 0 and 360 inclusive';
          }
        }

        if (! /^[0-9]+(?:\.[0-9]+)?|\.[0-9]+$/.test($('#turnIncrease').val())) {
          retVal = false;
          errorMessage += 'Turn increase must be a number';
        } else {
          var turnVal = parseFloat($('#turnIncrease').val());
          if (turnVal < 0.0 || turnVal > 360.0) {
            retVal = false;
            errorMessage += 'Turn increase must be between 0 and 360 inclusive';
          }
        }

        if (! /^[0-9]+(?:\.[0-9]+)?|\.[0-9]+$/.test($('#animationStepMultiplier').val())) {
          retVal = false;
          errorMessage += 'Step multiplier must be a (smallish) number';
        } else {
          var mult = parseFloat($('#animationStepMultiplier').val());
          if (mult < 0.0 || mult > 2.0 ) {
            //retVal = false;
            alert('You can continue, but multiplier should be small - like 1.001');
          }
        }

        if (currChecker.extraVars != null && currChecker.extraVars.length > 0) {
          var tempVal;
          for (let i = 0; i < currChecker.extraVars.length; i++) {
            tempVal = $('#' + currChecker.extraVars[i].id).val();
            if (tempVal == null || tempVal.length == 0) {
              errorMessage += 'Need input for "' + currChecker.extraVars[i].label + '" field\n';
              retVal = false;
            }
          }
        }
      }

      if (!retVal && errorMessage.length > 0) {
        alert(errorMessage);
      }

      return retVal;
    }

    function translatePoint( point ) {
      var retVal = [0.0,0.0];
      retVal[0] = (point[0] - viewBox[0]) / scale;
      retVal[1] = (point[1] - viewBox[1]) / scale;
      return retVal;
    }

    function draw() {
      resetDisplay();
      color = $('#pointColor').val();
      iterations = parseInt($('#numIterations').val());
      deltaTheta = parseFloat($('#deltaTheta').val());
      deltaTheta = deltaTheta * (Math.PI / 180.0);
      let extraVars = [];
      let extraVarValues = [0, 0, 0, 0, 0];
      let stateObj = JSON.parse(JSON.stringify(currChecker.stateObj));
      extraVars = currChecker.extraVars;
      if (extraVars != null && extraVars.length > 0) {
        for (let ex = 0; ex < extraVars.length; ex++) {
          extraVarValues[ex] = parseFloat($('#' + extraVars[ex].id).val());
        }
      }

      var ctx = stagingCanvas.getContext('2d');
      ctx.fillStyle = backgroundColor;
      ctx.beginPath();
      ctx.rect(0,0,stagingCanvas.width,stagingCanvas.height);
      ctx.fill();
      ctx.fillStyle = color;
      ctx.strokeStyle = color;
      ctx.beginPath();
      var prevPoint = null;

      for (var i = 1; i < iterations; i++) {
        prevPoint = drawInner(ctx, stateObj, i, extraVarValues[0], extraVarValues[1], prevPoint);
      }

      if( connectTheDots ) {
        //ctx.stroke();
      } else {
        ctx.fill();
      }

      var canvas = document.getElementById('canvasRoot');
      var context = canvas.getContext('2d');
      context.fillStyle = backgroundColor;
      context.clearRect(0,0,canvas.width,canvas.height);
      context.drawImage(stagingCanvas,0,0);
    }

    function drawInner(ctx, state, i, j, k, prev) {
      var retVal = prev;

      var checkResult = currChecker.checker(state, i, j, k);
      if (checkResult.draw) {

        p = translatePoint(coords);
        
        retVal = p;

        if( connectTheDots ) {
          // we are at the last point. draw a line.
          ctx.beginPath();
          if( prev != null ) {
            ctx.moveTo( prev[0],prev[1]);
            ctx.lineTo( p[0],p[1]);
            ctx.stroke();
            ctx.beginPath();
          }
          ctx.arc( p[0], p[1], pointRadius / scale, 0, 2 * Math.PI );
          ctx.stroke();
        } else {
          ctx.moveTo(p[0],p[1]);
          ctx.arc( p[0], p[1], pointRadius / scale, 0, 2 * Math.PI );
        }
      }

      if( checkResult.turn ) {
        currTheta += deltaTheta;
        if( turnIncrease != 0 ) {
          deltaTheta += turnIncrease;
          //$('#deltaTheta').val('' + deltaTheta);
        }
        if (currTheta > (2.0 * Math.PI)) {
          currTheta -= (2.0 * Math.PI);
        }
      }

      coords[0] += (2.0 * Math.cos(currTheta));
      coords[1] += (2.0 * Math.sin(currTheta));

      return retVal;
    }

    function startAnimation() {
      animating = true;
      animationInner();
    }

    function animationInner() {
      frameID = window.requestAnimationFrame(animationInner);
      var mult = reverse ? -1.0 : 1.0;
      draw();
      var dt = parseFloat($('#deltaTheta').val());
      animationStepMultiplier = parseFloat($('#animationStepMultiplier').val());
      if( animationStepMultiplier != 1.0 ) {
        animationStep *= animationStepMultiplier;
        $('#animationStep').val(''+animationStep);
      }
      if( animationStep >= 360.0 ) animationStep = 0.015;
      var newVal = dt + (mult * animationStep);
      if (newVal > 360.0) {
        newVal = 0.0;
      } else if (newVal < 0.0) {
        newVal = 360.0;
      }

      $('#deltaTheta').val('' + newVal);
    }

    function stopAnimation() {
      window.cancelAnimationFrame(frameID);
      animating = false;
    }

    function initChecker() {
      if (currChecker != null) {
        $('#checkerDescription').html(currChecker.description);
        $('#dynamicInputs').empty();
        let tempInput = "";
        let tempVar = {};
        if (currChecker.extraVars) {
          for (let i = 0; i < currChecker.extraVars.length; i++) {
            tempInput = "<td>";
            tempVar = currChecker.extraVars[i];
            tempInput += "<label for='" + tempVar.id + "'>" + tempVar.label + "</label>";
            if (tempVar.values) {
              // it's a select
              tempInput += "<select id='" + tempVar.id + "'><option value=''>Choose One</option>";
              for (let i = 0; i < tempVar.values.length; i++) {
                tempInput += "<option value='" + tempVar.values[i] + "'>" + tempVar.values[i] + "</option>";
              }
              tempInput += "</select>";
            } else {
              // it's an input
              tempInput += "<input id='" + tempVar.id + "'/>";
            }

            tempInput += "</td>";
            $('#dynamicInputs').append($(tempInput));
          }
        }
      }
    }
    const checkerMap = {};
    let currChecker = null;
    $(document).ready(function () {
      let selectOptions = [["Select One", ""]];
      let temp = [];
      for (var i = 0; i < checkers.length; i++) {
        temp = [];
        temp.push(checkers[i].name);
        temp.push(checkers[i].id);
        temp.push(checkers[i].default ? true : false);
        selectOptions.push(temp);
        checkerMap[checkers[i].id] = checkers[i];
      }
      $('#selectHolder').append($("<select id='checkerSelect'></select>"));
      for (let i = 0; i < selectOptions.length; i++) {
        $('#checkerSelect').append($("<option value='" + selectOptions[i][1] + "'" + (selectOptions[i][2] ? " selected" : "") + ">" + selectOptions[i][0] + "</option>"));
      }

      // if there is a pre-selected checked, initialize it.
      currChecker = checkerMap[$('#checkerSelect').val()];
      initChecker();

      $('#checkerSelect').on('change', function (e) {
        currChecker = checkerMap[$('#checkerSelect').val()];
        initChecker();
      });

      $('#submitBtn').on('click', function (e) {
        if (validateInputs()) {
          draw();
        }
      });

      $('#playBtn').on('click', function (e) {
        if (validateInputs()) {
          stopAnimation();
          reverse = false;
          startAnimation();
        }
      });

      $('#reverseBtn').on('click', function (e) {
        if (validateInputs()) {
          stopAnimation();
          reverse = true;
          startAnimation();
        }
      });

      $('#pauseBtn').on('click', function (e) {
        stopAnimation();
      });

      $('#canvasRoot').on('click', function (e) {
        centerOnOffset(e.offsetX, e.offsetY);
      });

      $('#connectDots').on('change', function (e) {
        if ($('#connectDots').is(":checked")) {
          connectTheDots = true;
        } else {
          connectTheDots = false;
        }
      });

      $('#pointColor').on('change', function (e) {
        color = $('#pointColor').val();
      });

      $('#backgroundColor').on('change', function (e) {
        backgroundColor = $('#backgroundColor').val();
      });

      $('#dotRadius').on('change', function(e) {
        pointRadius = parseFloat($('#dotRadius').val());
      });

      $('#animationStep').on('change', function (e) {
        animationStep = parseFloat($('#animationStep').val());
      });

      $('#animationStepMultipler').on('change', function (e) {
        animationStepMultiplier = parseFloat($('#animationStepMultiplier').val());
      });

      $('#turnIncrease').on('change', function(e){
        var temp = parseFloat($('#turnIncrease').val());
        turnIncrease = temp * (Math.PI / 180.0);
      });

      resize();
      $(window).resize(function () {
        resize();
      });
    });
  </script>
</head>
<body>
  <div id="controlPanel">
    <table>
      <tr>
        <td id="selectHolder"></td>
        <td id="checkerDescription"></td>
      </tr>
    </table>
    <table>
      <tr id="dynamicInputs"></tr>
    </table>
    <table>
      <tr>
        <td class="disp"><label for="pointColor">Color of points:</label><input type="color" value="#A132EC"
            id="pointColor" /></td>
        <td class="disp"><label for="backgroundColor">Background color:</label><input type="color" value="#000000"
            id="backgroundColor" /></td>
        <td class="disp"><label for="dotRadius">Dot radius:</label><input type="text" id="dotRadius" value="5" /></td>
        <td class="disp"><label for="connectDots">Wireframe?</label><input type="checkbox" id="connectDots" /></td>
      </tr>
    </table>
    <table>
      <tr>
        <td class="disp"><label for="deltaTheta">Angle to turn by (deg):</label><input type="text" value="90" size="10"
            id="deltaTheta" /></td>
        <td><label for="numIterations"># of Iterations:</label><input type="text" value="80000" id="numIterations" />
        </td>
        <td><input id="submitBtn" type="button" value="Render" /></td>
        <td><input id="zoomin" type="button" value="+" onclick="contract();" /></td>
        <td><input id="zoomout" type="button" value="-" onclick="expand();" /></td>
      </tr>
    </table>
    <table id="animationControls">
      <tr>
        <td class="disp"><label for="animationStep">Animation step (deg):</label><input type="text" value=".015"
            size="10" id="animationStep" /></td>
        <td class="disp"><label for="animationStepMultiplier">Step multiplier:</label><input type="text" value="1.0"
          size="10" id="animationStepMultiplier" /></td>
        <td class="disp"><label for="turnIncrease">Turn increase:</label><input type="text" value="0.0"
          size="10" id="turnIncrease" /></td>
        <td><button id="reverseBtn"><span class="material-icons md-light btnFlip">play_arrow</span></button></td>
        <td><button id="pauseBtn"><span class="material-icons md-light">stop</span></button></td>
        <td><button id="playBtn"><span class="material-icons md-light">play_arrow</span></button></td>
      </tr>
    </table>
  </div>
  <div id="canvasContainer">
    <canvas width="640" height="320" id="canvasRoot">
      
    </canvas>
  </div>
</body>

</html>