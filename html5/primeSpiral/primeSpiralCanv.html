<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=1.0, user-scalable=0"/>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style type="text/css">
    label {
      font-family: "Helvetica";
      padding-right: 5px;
    }

    .disp {
      padding-right: 25px;
    }

    .smallcolorpick {
      width: 35px !important;
    }

    .smalltextinput {
      max-width: 60px;
    }

    .mediuminput {
      width: 100px !important;
    }

    .buttonicon {
      font-size: .875rem !important;
      line-height: 1.5;
      vertical-align: bottom;
    }

    .btnFlip {
      transform: rotate(180deg);
    }

    * {
      touch-action: manipulation;
    }

    html,
    body {
      overscroll-behavior-y: contain;
    }
  </style>
</head>
<body>
  <div id="controlPanel" class="container-fluid">
    <div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkerDescriptionTitle"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="checkerDescription"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-3" id="selectHolder">
        <div class="input-group input-group-sm mb-2 mt-3">
          <div class="input-group-prepend">
            <button id="submitBtn" class="btn btn-secondary" type="button">Render</button>
          </div>
          <select class="custom-select" id="checkerSelect">
          </select>
          <div class="input-group-append">
            <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#descriptionModal"><i class="material-icons buttonicon">
              info
            </i></button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div id="dynamicInputs" class="col-md-3">
      </div>
    </div>
    <div class="row" id="viewOptions">
      <div class="col-md">
        <div class="btn-toolbar" role="toolbar">
          <div class="input-group input-group-sm mb-2 mr-1">
            <div class="input-group-prepend">
              <span class="input-group-text material-icons">
                adjust
                </span>
            </div>
            <input value="5" type="text" id="dotRadius" class="form-control smalltextinput" placeholder="Dot Radius" aria-label="Dot Radius" aria-describedby="basic-addon1">
          </div>
          <div class="btn-group btn-group-sm mb-2 mr-1" role="group" aria-label="First group">
            <button type="button" id="connectDots" class="btn btn-secondary btn-sm">
              <i class="material-icons buttonicon" id="connectDotsIcon">
                scatter_plot
              </i>
            </button>
          </div>
          <div class="input-group input-group-sm mb-2 mr-1">
            <div class="input-group-prepend">
              <span class="input-group-text material-icons">
                format_color_fill
              </span>
            </div>
            <input value="#000000" type="color" id="backgroundColor" class="form-control smallcolorpick" placeholder="Background Color" aria-label="Background Color" aria-describedby="basic-addon1">
          </div>
          <div class="input-group input-group-sm mb-2 mr-1">  
            <div class="input-group-prepend">
              <span class="input-group-text material-icons">
                color_lens
                </span>
            </div>
            <input value="#D10000" type="color" id="pointColor1" class="form-control smallcolorpick pointColor" placeholder="Point Color #1" aria-label="Point Color #1" aria-describedby="basic-addon1">
            <div class="input-group-append">
              <button type="button" id="removeColor" class="btn btn-sm btn-secondary"><i class="material-icons buttonicon">
                remove_circle
              </i></button>
              <button type="button" id="addColor" class="btn btn-sm btn-secondary"><i class="material-icons buttonicon">
                add_circle
              </i></button>
            </div>
          </div>
          <div class="btn-group btn-group-sm mb-2 mr-1" role="group" aria-label="First group">
            <button type="button" id="reverseBtn" class="btn btn-secondary"><i class="material-icons buttonicon btnFlip" id="connectDotsIcon">
              play_arrow
            </i></button>
            <button type="button" id="pauseBtn" class="btn btn-secondary"><i class="material-icons buttonicon" id="connectDotsIcon">
              stop
            </i></button>
            <button type="button" id="playBtn" class="btn btn-secondary"><i class="material-icons buttonicon" id="connectDotsIcon">
              play_arrow
            </i></button>
          </div>
          <div class="btn-group btn-group-sm mb-2" role="group" aria-label="First group">
            <button type="button" id="zoomout" class="btn btn-secondary"><i class="material-icons buttonicon" id="connectDotsIcon">
              zoom_out
            </i></button>
            <button type="button" id="zoomin" class="btn btn-secondary"><i class="material-icons buttonicon" id="connectDotsIcon">
              zoom_in
            </i></button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md">
        <div class="btn-toolbar" role="toolbar">
          <div class="input-group input-group-sm mb-2 mr-1">  
            <div class="input-group-prepend">
              <span class="input-group-text material-icons">
                tag
                </span>
            </div>
            <input value="80000" type="text" id="numIterations" class="mediuminput form-control" placeholder="# Iterations" aria-label="# Iterations" aria-describedby="basic-addon1">
          </div>
          <div class="input-group input-group-sm mb-2 mr-1">  
            <div class="input-group-prepend">
              <span class="input-group-text">
                &#952;
                </span>
            </div>
            <input value="90" type="text" id="deltaTheta" class="mediuminput form-control" placeholder="Turn Angle" aria-label="Turn Angle" aria-describedby="basic-addon1">
          </div>
          <div class="input-group input-group-sm mb-2 mr-1">  
            <div class="input-group-prepend">
              <span class="input-group-text">
                &#916;&#952;
                </span>
            </div>
            <input value=".015" type="text" id="animationStep" class="mediuminput form-control" placeholder="Animation Step" aria-label="Animation Step" aria-describedby="basic-addon1">
          </div>
          <div class="input-group input-group-sm mb-2 mr-1">  
            <div class="input-group-prepend">
              <span class="input-group-text material-icons">
                insights
                </span>
            </div>
            <input value="0.0" type="text" id="turnIncrease" class="mediuminput form-control" placeholder="Turn Increase" aria-label="Turn Increase" aria-describedby="basic-addon1">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="row" id="canvasContainer">
      <div class="col-md-12">
        <canvas width="640" height="320" id="canvasRoot"></canvas>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
  crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"></script>
  <script type="text/javascript" src="bigConstants.js"></script>
  <script type="text/javascript" src="checkers.js"></script>
  <script type="text/javascript">

    var viewBox = [-320, -320, 640, 640];

    var scale = 1.0;
    var resizing = false;
    var centerPoint = [0.0,0.0];
    var pointRadius = 5.0;

    var stagingCanvas = null;
    var connectTheDots = false;
    var coords = [0, 0];
    var color = '#D10000';
    var secondaryColor = '#FFFFFF';
    var backgroundColor = '#000000';
    var currTheta = 0;
    var deltaTheta = 90;
    var animationStep = .015;
    var reverse = false;
    var primeIdx = 0;
    var primeDotMap = {};
    var animating = false;
    var animationInterval = null;
    var frameID = null;
    var turnIncrease = 0.0;
    var zooming = false;
    var useGradient = false;
    var numColors = 1;
    var maxColors = 7;

    // experimental
    var gradient = null;
    //var num = 0;
    var drawInterval = null;
    var iterations = 80000;

    // for touching/dragging
    const touchContext = {
      prevTime : (new Date()).getTime(),
      prevX : 0,
      prevY : 0,
      lastRate : 0.0,
      dragging : false
    };

    var cannedColors = ['#FF6622','#FFDA21','#33DD00','#1133CC','#220066','#330044'];

    var processTouch = () => {
      var cnv = document.getElementById("canvasRoot");
      var dx = ((touchContext.currX * viewBox[2]) / cnv.width) -
               ((touchContext.prevX * viewBox[2]) / cnv.width);
      var dy = ((touchContext.currY * viewBox[3]) / cnv.width) -
               ((touchContext.prevY * viewBox[3]) / cnv.width);
      touchContext.prevX = touchContext.currX;
      touchContext.prevY = touchContext.currY;
      var newX = centerPoint[0] - dx;
      var newY = centerPoint[1] - dy;
      centerPoint = [ newX, newY ];
      resize();
      if ( !animating ) draw();
    }

    function expand() {
      if( !zooming ) {
        if( !animating ) {
          scale *= 2.0;
          resize();
          draw();
        } else {
          zooming = true;
          var ds = (scale - (2 * scale)) / 100.0;
          new Promise( function( resolve, reject ) {
            centerOnOffsetInner( resolve, 100, 0, 0, ds );
          }).then(function(result) {
            zooming = false;
          });
        }
      }
    }

    function contract() {
      if( !zooming ) {
        if( !animating ) {
          scale *= 0.5;
          resize();
          draw();
        } else {
          zooming = true;
          var ds = (scale - (.5 * scale)) / 100.0;
          new Promise( function( resolve, reject ) {
            centerOnOffsetInner( resolve, 100, 0, 0, ds );
          }).then(function(result) {
            zooming = false;
          });
        }
      }
    }

    function centerOnOffset(offx, offy) {
      if( !zooming ) {
        var cnv = document.getElementById("canvasRoot");
        var newX = ((offx * viewBox[2]) / cnv.width) + viewBox[0];
        var newY = ((offy * viewBox[3]) / cnv.height) + viewBox[1];

        if( !animating ) {
          centerPoint[0] = newX;
          centerPoint[1] = newY;
          contract();
        } else {
          zooming = true;
          var dx = (newX - centerPoint[0]) / 100.0;
          var dy = (newY - centerPoint[1]) / 100.0;
          var ds = (scale - (.5 * scale)) / 100.0;

          new Promise( function( resolve, reject ) {
            centerOnOffsetInner( resolve, 100, dx, dy, ds );
          }).then(function(result) {
            zooming = false;
          });
        }
      }
    }

    function centerOnOffsetInner( resolve, count, xDec, yDec, scaleDec ) {
      if( count > 0 ) {
        centerPoint[0] += xDec;
        centerPoint[1] += yDec;
        scale -= scaleDec;
        resize();
        if( !animating ) draw(); 
        setTimeout( function () {
          centerOnOffsetInner( resolve, count - 1, xDec, yDec, scaleDec );
        }, 7 );
      } else {
        resolve("Done");
      }
    }

    function resize() {
      $('#canvasContainer').css({ height: ($(window).innerHeight() - $('#controlPanel').height()) });
      var cnv = document.getElementById("canvasRoot");
      if( cnv.width != $('#canvasContainer').width()) cnv.width = $('#canvasContainer').width();
      cnv.height = $('#canvasContainer').height();
      viewBox[0] = centerPoint[0] - (scale * cnv.width / 2.0);
      viewBox[1] = centerPoint[1] - (scale * cnv.height / 2.0);
      viewBox[2] = cnv.width * scale;
      viewBox[3] = cnv.height * scale;
    }

    function initCanvas() {
      var canvas = document.getElementById('canvasRoot');
      stagingCanvas = document.createElement('canvas');
      stagingCanvas.width = canvas.width;
      stagingCanvas.height = canvas.height;
    }

    function resetDisplay() {
      initCanvas();
      coords = [0, 0];
      currTheta = 0;
      primeIdx = 0;
    }

    function multipleOf(n, m) {
      return n % m == 0;
    }

    function validateInputs() {
      let retVal = true;
      let errorMessage = '';
      if (currChecker == null) {
        retVal = false;
        errorMessage += "Select a checker!";
      } else {
        if (! /^[0-9]+$/.test($('#numIterations').val())) {
          retVal = false;
          errorMessage += '# of Iterations must be numeric (more the merrier)\n';
        }

        if (! /^[0-9]+(?:\.[0-9]+)?|\.[0-9]+$/.test($('#deltaTheta').val())) {
          retVal = false;
          errorMessage += 'Angle must be a number between 0 and 360 inclusive';
        } else {
          var dtheta = parseFloat($('#deltaTheta').val());
          if (dtheta < 0.0 || dtheta > 360.0) {
            retVal = false;
            errorMessage += 'Angle must be between 0 and 360 inclusive';
          }
        }

        if (! /^[0-9]+(?:\.[0-9]+)?|\.[0-9]+$/.test($('#turnIncrease').val())) {
          retVal = false;
          errorMessage += 'Turn increase must be a number';
        } else {
          var turnVal = parseFloat($('#turnIncrease').val());
          if (turnVal < 0.0 || turnVal > 360.0) {
            retVal = false;
            errorMessage += 'Turn increase must be between 0 and 360 inclusive';
          }
        }

        if (currChecker.extraVars != null && currChecker.extraVars.length > 0) {
          var tempVal;
          for (let i = 0; i < currChecker.extraVars.length; i++) {
            tempVal = $('#' + currChecker.extraVars[i].id).val();
            if (tempVal == null || tempVal.length == 0) {
              errorMessage += 'Need input for "' + currChecker.extraVars[i].label + '" field\n';
              retVal = false;
            }
          }
        }
      }

      if (!retVal && errorMessage.length > 0) {
        alert(errorMessage);
      }

      return retVal;
    }

    function translatePoint( point ) {
      var retVal = [0.0,0.0];
      retVal[0] = (point[0] - viewBox[0]) / scale;
      retVal[1] = (point[1] - viewBox[1]) / scale;
      return retVal;
    }

    function draw() {
      resetDisplay();
      color = $('#pointColor1').val();
      iterations = parseInt($('#numIterations').val());
      deltaTheta = parseFloat($('#deltaTheta').val());
      deltaTheta = deltaTheta * (Math.PI / 180.0);
      let extraVars = [];
      let extraVarValues = [0, 0, 0, 0, 0];
      let stateObj = JSON.parse(JSON.stringify(currChecker.stateObj));
      extraVars = currChecker.extraVars;
      if (extraVars != null && extraVars.length > 0) {
        for (let ex = 0; ex < extraVars.length; ex++) {
          extraVarValues[ex] = parseFloat($('#' + extraVars[ex].id).val());
        }
      }

      var ctx = stagingCanvas.getContext('2d');
      if( numColors > 1 ) {
        var ctr = translatePoint([0.0,0.0]);
        gradient = ctx.createRadialGradient(ctr[0], ctr[1], 0,
                                 ctr[0], ctr[1], Math.max(stagingCanvas.width,stagingCanvas.height) / 2.0);
        
        var colorStep = 1.0 / (numColors + 1.0);
        for( var i = 0; i < numColors; i++ ) {
          gradient.addColorStop( i*colorStep, $('#pointColor'+(i+1)).val());
        }

        gradient.addColorStop(1,backgroundColor);
      } else {
        gradient = null;
      }

      ctx.fillStyle = backgroundColor;
      ctx.beginPath();
      ctx.rect(0,0,stagingCanvas.width,stagingCanvas.height);
      ctx.fill();
      ctx.fillStyle = gradient != null ? gradient : color;
      ctx.strokeStyle = gradient != null ? gradient : color;
      ctx.beginPath();
      var prevPoint = null;

      for (var i = 1; i < iterations; i++) {
        prevPoint = drawInner(ctx, stateObj, i, extraVarValues[0], extraVarValues[1], prevPoint);
      }

      if( connectTheDots ) {
        //ctx.stroke();
      } else {
        ctx.fill();
      }

      var canvas = document.getElementById('canvasRoot');
      var context = canvas.getContext('2d');
      context.fillStyle = backgroundColor;
      context.clearRect(0,0,canvas.width,canvas.height);
      context.drawImage(stagingCanvas,0,0);
    }

    function drawInner(ctx, state, i, j, k, prev) {
      var retVal = prev;

      var checkResult = currChecker.checker(state, i, j, k);
      if (checkResult.draw) {

        p = translatePoint(coords);

        retVal = p;

        if( connectTheDots ) {
          // we are at the last point. draw a line.
          ctx.beginPath();
          if( prev != null ) {
            ctx.moveTo( prev[0],prev[1]);
            ctx.lineTo( p[0],p[1]);
            ctx.stroke();
            ctx.beginPath();
          }
          ctx.arc( p[0], p[1], pointRadius / scale, 0, 2 * Math.PI );
          ctx.stroke();
        } else {
          ctx.moveTo(p[0],p[1]);
          ctx.arc( p[0], p[1], pointRadius / scale, 0, 2 * Math.PI );
        }
      }

      if( checkResult.turn ) {
        currTheta += deltaTheta;
        if( checkResult.turnIncrease != null ) {
          deltaTheta += checkResult.turnIncrease;
        } else if( turnIncrease != 0 ) {
          deltaTheta += turnIncrease;
          //$('#deltaTheta').val('' + deltaTheta);
        }
        if (currTheta > (2.0 * Math.PI)) {
          currTheta -= (2.0 * Math.PI);
        }
      }

      coords[0] += (2.0 * Math.cos(currTheta));
      coords[1] += (2.0 * Math.sin(currTheta));

      return retVal;
    }

    function startAnimation() {
      animating = true;
      animationInner();
    }

    function animationInner() {
      frameID = window.requestAnimationFrame(animationInner);
      var mult = reverse ? -1.0 : 1.0;
      draw();
      var dt = parseFloat($('#deltaTheta').val());
      if( animationStep >= 360.0 ) animationStep = 0.015;
      var newVal = dt + (mult * animationStep);
      if (newVal > 360.0) {
        newVal = 0.0;
      } else if (newVal < 0.0) {
        newVal = 360.0;
      }

      $('#deltaTheta').val('' + newVal);
    }

    function stopAnimation() {
      window.cancelAnimationFrame(frameID);
      animating = false;
    }


    // <div class="input-group input-group-sm mb-2 mr-1">  
    //   <div class="input-group-prepend">
    //     <span class="input-group-text">
    //       &#916;&#952;
    //       </span>
    //   </div>
    //   <input value=".015" type="text" id="animationStep" class="mediuminput form-control" placeholder="Animation Step" aria-label="Animation Step" aria-describedby="basic-addon1">
    // </div>
    function initChecker() {
      if (currChecker != null) {
        $('#checkerDescription').html(currChecker.description);
        $('#checkerDescriptionTitle').html(currChecker.name);
        $('#dynamicInputs').empty();
        let tempInput = '<div class="input-group input-group-sm mb-2 mr-1">';
        let tempVar = {};
        if (currChecker.extraVars) {
          for (let i = 0; i < currChecker.extraVars.length; i++) {
            tempVar = currChecker.extraVars[i];
            tempInput += '<div class="input-group-prepend"><span class="input-group-text">' + tempVar.label + '</span></div>';
            if (tempVar.values) {
              // it's a select
              tempInput += "<select id='" + tempVar.id + "' class='custom-select'><option value=''>Choose One</option>";
              var selected = false;
              for (let i = 0; i < tempVar.values.length; i++) {
                selected = tempVar.values[i] == tempVar.defaultVal;
                tempInput += "<option "+ (selected ? 'selected' : '') +" value='" + tempVar.values[i] + "'>" + tempVar.values[i] + "</option>";
              }
              tempInput += "</select>";
            } else {
              // it's an input
              tempInput += "<input class='form-control' id='" + tempVar.id + "' value='" + tempVar.defaultVal +"'/>";
            }

            tempInput += "</div>";
            $('#dynamicInputs').append($(tempInput));
          }
        }
      }
    }
    const checkerMap = {};
    let currChecker = null;

    $(document).ready(function () {
      let selectOptions = [["Select One", ""]];
      let temp = [];
      for (var i = 0; i < checkers.length; i++) {
        temp = [];
        temp.push(checkers[i].name);
        temp.push(checkers[i].id);
        temp.push(checkers[i].default ? true : false);
        selectOptions.push(temp);
        checkerMap[checkers[i].id] = checkers[i];
      }
      for (let i = 0; i < selectOptions.length; i++) {
        $('#checkerSelect').append($("<option value='" + selectOptions[i][1] + "'" + (selectOptions[i][2] ? " selected" : "") + ">" + selectOptions[i][0] + "</option>"));
      }

      // if there is a pre-selected checked, initialize it.
      currChecker = checkerMap[$('#checkerSelect').val()];
      initChecker();

      $('#checkerSelect').on('change', function (e) {
        currChecker = checkerMap[$('#checkerSelect').val()];
        initChecker();
      });

      $('#submitBtn').on('click', function (e) {
        if (validateInputs()) {
          draw();
        }
      });

      $('#playBtn').on('click', function (e) {
        if (validateInputs()) {
          stopAnimation();
          reverse = false;
          startAnimation();
        }
      });

      $('#reverseBtn').on('click', function (e) {
        if (validateInputs()) {
          stopAnimation();
          reverse = true;
          startAnimation();
        }
      });

      $('#pauseBtn').on('click', function (e) {
        stopAnimation();
      });

      $('#zoomin').on('click', function(e) {
        contract();
      });

      $('#zoomout').on('click', function(e) {
        expand();
      });

      $('#addColor').on('click', function(e) {
        if( numColors < maxColors ) {
          numColors++;
          var newEle = $('<input value="'+cannedColors[numColors - 2]+'" type="color" id="pointColor'+numColors+'" class="form-control smallcolorpick" placeholder="Point Color #'+numColors+'" aria-label="Point Color #'+numColors+'" aria-describedby="basic-addon1">');
          newEle.insertAfter('#pointColor' + (numColors - 1) );
        }
      });

      $('#removeColor').on('click', function(e) {
        if( numColors > 1 ) {
          $('#pointColor'+numColors).remove();
          numColors--;
        }
      });

      $('#canvasRoot').on('dblclick', function (e) {
        centerOnOffset(e.offsetX, e.offsetY);
      });

      $('#connectDots').on('click', function (e) {
        if (!connectTheDots) {
          connectTheDots = true;
          $('#connectDotsIcon').html('linear_scale');
        } else {
          connectTheDots = false;
          $('#connectDotsIcon').html('scatter_plot');
        }
      });

      $('#useGradient').on('change', function (e) {
        if ($('#useGradient').is(":checked")) {
          useGradient = true;
          $('#secondaryColorHolder').show();
        } else {
          useGradient = false;
          $('#secondaryColorHolder').hide();
        }
      });

      $('#pointColor').on('change', function (e) {
        color = $('#pointColor').val();
      });

      $('#backgroundColor').on('change', function (e) {
        backgroundColor = $('#backgroundColor').val();
      });

      $('#secondaryColor').on('change', function (e) {
        secondaryColor = $('#secondaryColor').val();
      });

      $('#dotRadius').on('change', function(e) {
        pointRadius = parseFloat($('#dotRadius').val());
      });

      $('#animationStep').on('change', function (e) {
        animationStep = parseFloat($('#animationStep').val());
      });

      $('#turnIncrease').on('change', function(e){
        var temp = parseFloat($('#turnIncrease').val());
        turnIncrease = temp * (Math.PI / 180.0);
      });

      $('#canvasRoot').on( "touchstart", function(event) {
         event.preventDefault();
         touchContext.prevX = event.originalEvent.touches[0].pageX;
         touchContext.prevY = event.originalEvent.touches[0].pageY;
         var d = new Date();
         touchContext.prevTime = d.getTime();
         touchContext.dragging = true;
         touchContext.lastRate = 0.0;
        }).on("touchend", function(event) {
         event.preventDefault();
         touchContext.currX = event.originalEvent.changedTouches[0].pageX;
         touchContext.currY = event.originalEvent.changedTouches[0].pageY;
         var d = new Date();
         touchContext.currTime = d.getTime();
         touchContext.dragging = false;
         //processTouch();
        }).on( "mousedown", function(event) {
         touchContext.prevX = event.pageX;
         touchContext.prevY = event.pageY;
         var d = new Date();
         touchContext.prevTime = d.getTime();
         touchContext.dragging = true;
         touchContext.lastRate = 0.0;
        }).on("mouseup", function(event) {
         touchContext.currX = event.pageX;
         touchContext.currY = event.pageY;
         var d = new Date();
         touchContext.currTime = d.getTime();
         touchContext.dragging = false;
         //processTouch();
        }).on("mousemove", function(event) {
         if( touchContext.dragging ) {
           event.preventDefault();
           touchContext.currX = event.pageX;
           touchContext.currY = event.pageY;
           var d = new Date();
           touchContext.currTime = d.getTime();
           processTouch();
         }
        }).on("touchmove", function(event) {
         if( touchContext.dragging ) {
           event.preventDefault();
           touchContext.currX = event.originalEvent.changedTouches[0].pageX;
           touchContext.currY = event.originalEvent.changedTouches[0].pageY;
           var d = new Date();
           touchContext.currTime = d.getTime();
           processTouch();
         }
        }).on("mouseout", function(event) {
          if( touchContext.dragging ) {
            touchContext.dragging = false;
          }
        });

      resize();
      $(window).resize(function () {
        resize();
      });
    });
  </script>
</body>
</html>