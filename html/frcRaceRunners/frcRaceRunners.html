<!doctype html>
<html lang="en">
  <head>
   <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=1.0, user-scalable=0">

    <title>Fishers Running Club Race Runners</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <style type="text/css">
      * {
        touch-action: manipulation;
      }
    </style>
  </head>
  <body>    

    <div class="container">
      <div class="row">
        <h1>Welcome to the Fishers Running Club Race Runner Tracker!</h1>
        <h4>This tool anonymously keeps track of how many Fishers Running Club members are running in upcoming races across the United States.</h4>
        <h5>If you arrived at this site by clicking on the link in the newsletter you can click "I'm Running!" on any of the displayed races, or search for your race if you don't see it in the list.  The tool will never display who is running which races for security reasons, but will keep an accurate count of how many members are participating in individual races.</h5>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <div class="input-group mb-3">
            <span class="input-group-text" id="raceFilterLabel">Filter</span>
            <input id="raceFilter" type="text" class="form-control" placeholder="Type to Filter" aria-label="Filter" aria-describedby="raceFilterLabel">
          </div>
        </div>
      </div>

      <div class="row" id="raceTable">
        <div class="col">
          
          <table style="table-layout: fixed" class="table caption-top">
            <caption class="w-100" id="tableCaption"></caption>
            <thead>
              <tr>
                <th scope="col" class="col-md-5 col-7">Race Name</th>
                <th scope="col" class="col-md-2 d-md-table-cell d-none">Location</th>
                <th scope="col" class="col-md-2 d-md-table-cell d-none">Date</th>
                <th scope="col" class="col-md-3 col-5">Runners</th>
              </tr>
            </thead>
            <tbody id="raceTableBody">
              <tr>
                <td colspan="4" style="width: 100%;" class="align-middle"><div class="d-flex justify-content-center">
                  <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script src="js/handlebars.min-v4.7.7.js"></script>
    <script type="text/javascript">
      
      var raceRowTemplate = null;
      var myEmail = null;

      let races = [];
      let raceIdx = {};
      var debounceTimer;

      function doFilter() {
        var filt = $('#raceFilter').val();
        filt = filt.toLowerCase();
        var filterList = races.filter((obj) => {
          return obj.name.toLowerCase().indexOf(filt) >= 0 ||
                  obj.location.toLowerCase().indexOf(filt) >= 0 ||
                  obj.date.toLowerCase().indexOf(filt) >= 0;
        });

        populateTable(filterList);
      }

      function sortRaceArray( arr ) {
        arr.sort((a,b) => {
          var atrim = a.name.trim();
          var btrim = b.name.trim();
          if( a.runners > b.runners ) {
            return -1;
          } else if( a.runners < b.runners ) {
            return 1;
          } else {
            if( atrim > btrim ) {
              return 1;
            } else if( atrim < btrim ) {
              return -1;
            } else {
              return 0;
            }
          }
        });
      }

      $(document).ready(() => {

        myEmail = getURLParameter('e');

        initializeTemplates();

        $('#raceFilter').keydown(() => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(function() {
            doFilter();
          }, 250);
        });



        $.ajax({
          url: 'https://www.mjmtools.com/frcRaces/',
          type: "POST",
          contentType: "application/json",
          dataType: "json",
          data: JSON.stringify( {
            email: myEmail
          } ),
          success: function( result ) {
            // populate the table
            //for( var i = 0; i < result.length; i++ ) {
            //  result[i].name = result[i].name.replaceAll('&#039;', "'");
            //  result[i].name = result[i].name.replaceAll('&amp;', '&');
            //}
            races = result;

            // build idx
            for( var i = 0; i < races.length; i++ ) {
              raceIdx[ races[i].id ] = races[i];
            }

            populateTable(races);
          },
          error: function( result ) {
            alert("Got an error response: " + result.responseText );
          }
        });
      });

      function populateTable( races ) {
        sortRaceArray(races);
        var rowContent = raceRowTemplate({
          races: races
        });
        $('#raceTableBody').empty();
        $('#raceTableBody').append(rowContent);

        if( myEmail && myEmail.length > 0 ) {
          $('.runningBtn').off();
          $('.runningBtn').one('click', (ele) => {
            imRunning( ele.currentTarget.getAttribute('data-race-id'), myEmail, ele.currentTarget );
          });
        } else {
          $('.runningBtn').attr('disabled','true');
        }
      }

      function imRunning( id, email, ele ) {

        var buttonEle = $(ele);
        if( email && email.length > 0 ) {
          var data = {
            id: id,
            email: email
          };

          $.ajax({
            url: 'https://www.mjmtools.com/frcRunners/',
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify( data ),
            success: function( result ) {
              buttonEle.removeClass('btn-primary');
              buttonEle.addClass('btn-success')
              buttonEle.html($('<span class="text-white">&#x2713;</span>'));
              buttonEle.attr('disabled', 'true');

              var runnersEle = $(".runningCounter[data-race-id='" + id + "']");
              var currRunners = parseInt(runnersEle.html());
              runnersEle.html( currRunners + 1 );
              raceIdx[id].runners++;
              raceIdx[id].running = true;
            },
            error: function( result ) {
              alert("Got an error response: " + result.responseText );
            }
          });
        } else {
          buttonEle.removeClass('btn-primary');
          buttonEle.addClass('btn-success')
          buttonEle.html($('<span class="text-white">&#x2713;</span>'));
          buttonEle.attr('disabled', 'true');
        }
      }

      function getURLParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      function initializeTemplates() {
        var source = $('#raceRowTemplate').html();
        raceRowTemplate = Handlebars.compile(source);
      }
    </script>

    <script id="raceRowTemplate" type="text/x-handlebars-template">
      {{#each races}}
        <tr>
          <td class="align-middle"><a href="{{url}}" target="_blank">{{name}}</a></td>
          <td class="d-md-table-cell d-none align-middle">{{location}}</td>
          <td class="d-md-table-cell d-none align-middle">{{date}}</td>
          <!--<td class="align-middle" data-race-id="{{id}}">{{runners}}</td>-->
          <td class="align-middle">
            <div class="btn-group" role="group" aria-label="Runners">
              <button type="button" data-race-id="{{id}}" class="fw-bold btn btn-sm btn-outline-primary runningCounter" disabled>{{runners}}</button>
              {{#if running}}
              <button type="button" class="btn btn-sm btn-success" disabled><span class="text-white">&#x2713;</span></button>
              {{else}}
              <button type="button" data-race-id="{{id}}" class="btn btn-sm btn-primary runningBtn"><span class="text-white fw-bold">+</span>&nbsp;I'm Running!</button>
              {{/if}}
            </div>
          </td>
        </tr>
      {{/each}}
    </script>
  </body>
</html>
